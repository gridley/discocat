#include "lsquadrature.h"

Ray::Ray(float mu_a, float eta_a, float theta_a, float wgt_a) :
  mu(mu_a),
  eta(eta_a),
  theta(theta_a),
  wgt(wgt_a)
{
}
Ray::Ray() :
  mu(0.0),
  eta(0.0),
  theta(0.0),
  wgt(0.0)
{
}

LSQuadrature::LSQuadrature(unsigned na, MomType ma) :
  quadtype(ma),
  i(0),
  j(0),
  n(na),
  mu(n),
  weights(n),
  point_weights(n)
{
  fillEntries();
  generateMap();
  normalize4Pi();
}

unsigned LSQuadrature::nOct()
{
  return n * (n+2) / 8;
}


bool LSQuadrature::iterateOctant(float& xi1, float& xi2, float& xi3, float& wgt)
{
  if (j == n/2-i)
  {
    j=0; ++i;
    if (i == n/2)
    {
      // Done with this octant
      i = j = 0;
      return false;
    }
  }
  unsigned k = n/2-i-j-1;
  std::array<unsigned, 3> indx = {i, j, k};
  xi1 = mu[i];
  xi2 = mu[j];
  xi3 = mu[k];
  wgt = point_weights[indices2wgt[indx]];
#ifdef PRINT_ANGLE
  std::cout << "mu = " << xi1 << " eta = " << xi2 << " xi = "
            << xi3 << " wgt = " << wgt << std::endl;
#endif
  ++j;
  return true;
}

bool LSQuadrature::iterateOctant(Ray& ray)
{
  return LSQuadrature::iterateOctant(ray.mu, ray.eta, ray.theta, ray.wgt);
}

void LSQuadrature::normalize4Pi()
{
  for (unsigned w=0; w<n; ++w)
    point_weights[w] *= M_PI / 2.0;
}

void LSQuadrature::generateMap()
{
  unsigned group = 0;
  for (unsigned i=0; i<n/2; ++i)
    for (unsigned j=0; j<n/2-i; ++j)
    {
      unsigned k = n/2-i-j-1;
      std::array<unsigned, 3> indx = {i, j, k};

      if (indices2wgt.find(indx) == indices2wgt.end())
      {
        // Loop over permutations, and add to map
        std::sort(indx.begin(), indx.end());
        do
        {
          indices2wgt.insert(make_pair(indx, group));
        } while (std::next_permutation(indx.begin(), indx.end()));
        group++;
      }
    }
}

void LSQuadrature::fillEntries()
{
  if (n == 4 and quadtype == EVEN)
  {
    mu = {0.35002099068728404, 0.8688904488809763};
    weights = {0.3333327579468404, 0.16666675857903693};
    point_weights = {0.33333290978908703};
  }


  else if (n == 4 and quadtype == ODD)
  {
    mu = {0.5773507143168236, 0.5773493789342006};
    weights = {0.03349256567027269, 0.4665074336431592};
    point_weights = {0.21339702599348181};
  }


  else if (n == 6 and quadtype == EVEN)
  {
    mu = {0.26662690272265666, 0.6815093890565717, 0.9261858288103128};
    weights = {0.25472472374993954, 0.157217112609132, 0.08805819548149077};
    point_weights = {0.17611622066385169, 0.15721709132174072};
  }


  else if (n == 6 and quadtype == ODD)
  {
    mu = {0.18386707503171423, 0.695051400516279, 0.9656012621359625};
    weights = {0.21789962393575377, 0.23086717534136986, 0.05123309273207347};
    point_weights = {0.10246607178865888, 0.23086716113193387};
  }


  else if (n == 8 and quadtype == EVEN)
  {
    mu = {0.21797368578431997, 0.5773502691896258, 0.7868634817884645,
      0.9513017106108856};
    weights = {0.21161078970456618, 0.13718364354804574, 0.09079976352248505,
      0.060407957198302296};
    point_weights = {0.12081265558692225, 0.09079894882006449, 0.09276938945596258};
  }


  else if (n == 8 and quadtype == ODD)
  {
    mu = {0.14224906667325404, 0.5773502691896257, 0.8040098691541384,
      0.9795562291472482};
    weights = {0.1721789902269744, 0.21015644925447666, 0.0631545648365536,
      0.05451014203259958};
    point_weights = {0.10902304494868022, 0.06315525505742389, 0.29400238839410564};
  }


  else if (n == 10 and quadtype == EVEN)
  {
    mu = {0.19149943189158633, 0.5090854624753098, 0.6940201609410204,
      0.8391423952354568, 0.9626296978435681};
    weights = {0.18577518519489822, 0.12383004196924607, 0.07386686978777347,
      0.0710124356136764, 0.04551693183495317};
    point_weights = {0.0910337779135841, 0.07101240881482576, 0.04745803981113794,
      0.05281763851419059};
  }


  else if (n == 10 and quadtype == ODD)
  {
    mu = {0.1122370141293383, 0.5031394308093605, 0.7026389018049494,
      0.8568859701408136, 0.9873224930683293};
    weights = {0.1383647186405955, 0.23419106198895143, -0.037581338829574144,
      0.15247316829307356, 0.012552130054375428};
    point_weights = {0.025108584808403382, 0.152474519761715, -0.07843893420887167,
      0.08171627193350829};
  }


  else if (n == 12 and quadtype == EVEN)
  {
    mu = {0.17699798148902476, 0.46101118661099283, 0.627482543908404,
      0.7582462473623254, 0.8695633389054159, 0.9681649803094624};
    weights = {0.17031187266508407, 0.10895089137089702, 0.06729609872010041,
      0.0625600782302001, 0.05230470265053714, 0.038576709010445534};
    point_weights = {0.07715595399710627, 0.052305590242212485, 0.040849694431711554,
      0.04342178198746319, 0.026446531087199583};
  }


  else if (n == 12 and quadtype == ODD)
  {
    mu = {0.09354429096189147, 0.4511099796597557, 0.6310704343618764,
      0.7700646547548781, 0.8875523938787004, 0.9912108409702116};
    weights = {0.11684843937318108, 0.2534340973259806, -0.14191114248976497,
      0.2670017312297047, -0.03958263868102494, 0.04420941919931071};
    point_weights = {0.08841872433327563, -0.039582678603895916, 0.06801242216013774,
      0.3979785725129959, -0.20992357035316994};
  }


  else if (n == 14 and quadtype == EVEN)
  {
    mu = {0.15873030027751306, 0.42339617473444585, 0.5773502691896258,
      0.698142067123093, 0.800919071093002, 0.8919306985377559,
      0.974479031866577};
    weights = {0.1545714147380058, 0.10149834422812588, 0.06606413976690309,
      0.05202033882371881, 0.050160713820995, 0.04444105316458564,
      0.03124444557575873};
    point_weights = {0.062488540395320154, 0.04444092163101164, 0.03652394581316423,
      0.022236189175118156, 0.027273360637562916, 0.02978410580407597,
      -0.00048782370067432246};
  }


  else if (n == 14 and quadtype == ODD)
  {
    mu = {0.09130286499468192, 0.4133216341359175, 0.5773502691896258,
      0.7041533167016125, 0.8113756549899864, 0.9059961443620925,
      0.9916287479130109};
    weights = {0.11243170222654292, 0.20183039950810688, -0.05522894292434305,
      0.14974788485433568, 0.018904422492553967, 0.05012892954973584,
      0.022185592044620856};
    point_weights = {0.044372993756454995, 0.0501296081749408, -0.043058870167877766,
      0.12197503609244303, 0.12392749015447013, 0.027773074970294263,
      -0.0798862954535192};
  }


  else if (n == 16 and quadtype == EVEN)
  {
    mu = {0.14954288529130758, 0.394507341623701, 0.537502568039214,
      0.6497553221809732, 0.7452884990097799, 0.8298963277482321,
      0.9066426434178746, 0.9773811185599514};
    weights = {0.14532326568782375, 0.09162414186661119, 0.06373894041151257,
      0.048371499617837516, 0.04436943081144827, 0.04205315314027992,
      0.036932864265424616, 0.027587234189812626};
    point_weights = {0.055174480362008754, 0.036932868972789586, 0.030514673797060465,
      0.022701239560369, 0.02307696553351525, 0.021668193390790635,
      0.019892224515493467, 0.011556072795719297};
  }


  else if (n == 16 and quadtype == ODD)
  {
    mu = {0.08066388757830267, 0.38285145404245985, 0.535391267173463,
      0.6532322573700622, 0.7528485605830484, 0.8407434378424542,
      0.9202815337592781, 0.9934720300448876};
    weights = {0.10019122831665807, 0.21201157764827427, -0.11748110174460664,
      0.21757442546940353, -0.00047421076773007664, -0.002984229215631907,
      0.0844223683280712, 0.00674011053600163};
    point_weights = {0.013479764870661458, 0.08442218910611546, -0.05210710617981627,
      0.05439649457003275, 0.0982454932418877, -0.054870786802288136,
      0.16842949454835932, -0.01050319246959703};
  }


  else if (n == 18 and quadtype == EVEN)
  {
    mu = {0.1436236968896649, 0.3713385974318573, 0.505130618332589,
      0.6102634916259274, 0.6997757618307975, 0.7790704104766639,
      0.8510083972057398, 0.9173221243102594, 0.9791549761827755};
    weights = {0.138421630131623, 0.08363734135678627, 0.06015899152067311,
      0.0463501833604911, 0.04087417001203296, 0.03826601852243416,
      0.035652511822388974, 0.03151920527654251, 0.025119369290341087};
    point_weights = {0.0502379920238728, 0.031518901987838674, 0.02888178966858095,
      0.02007861257911249, 0.015409041022840641, 0.013540977709610102,
      0.01818724263401961, 0.020390335674819304, 0.01014939998954359,
      0.005881211776659007};
  }


  else if (n == 18 and quadtype == ODD)
  {
    mu = {0.08176678231734358, 0.359414286279194, 0.501668667222334,
      0.6116896878023067, 0.7047390273390101, 0.7868608003616552,
      0.8611868215647723, 0.9295889221198183, 0.9932916926154854};
    weights = {0.10014376578006608, 0.1625394052208936, -0.015651686361272937,
      0.08371519215837037, 0.056264729321018364, 0.02326233567961778,
      0.03167617241950369, 0.044881305779059265, 0.013168457639627418};
    point_weights = {0.02633781815017112, 0.044881672570368986, 0.005466544673052555,
      0.019273259989419395, 0.008368489358649586, 0.052419819787224896,
      0.003989273193211313, 0.06124849859650768, -0.026704291550548823,
      0.0031934617871594317};
  }

  else
  {
    std::cerr << "No recorgnized quadrature saved for S_" << n
      << quadtype << " type." << std::endl;
    exit(1);
  }
}


